<html>
<head>
    <title>JIMP + Web Worker Proof of Concept</title>
    <script src="jimp.js" type="text/javascript"></script>
    <!-- Minify the script using: -->
    <!-- $ uglifyjs --compress --mangle -o jimp.min.js -- jimp.js-->
    <!-- Install uglify via $ npm install uglify-js -g-->
    <!-- minified and gzipped, the whole image processing mess is down to 306kb... fine, I think, considering how much server load it saves. -->

    <script type="text/javascript">

        var worker = new Worker("jimp-worker.js");
        worker.onmessage = function(e) {
            console.log("RETURN TO MAIN APP!",e);
            console.log(e.data); // e.data should be an array of ArrayBuffers.

            // display the return data by drawing in a canvas:
            var firstImage = e.data[0];
            console.log("firstimage: ",firstImage);
            var canvas = document.createElement("canvas");
            canvas.width = firstImage.width;
            canvas.height = firstImage.height;
            document.body.appendChild(canvas);

            var ctx = canvas.getContext("2d");
            var imgData = ctx.createImageData(firstImage.width,firstImage.height);

            var ubuf = firstImage.data;
            for (var i=0;i < ubuf.length; i+=4) {
                imgData.data[i]   = ubuf[i];   //red
                imgData.data[i+1] = ubuf[i+1]; //green
                imgData.data[i+2] = ubuf[i+2]; //blue
                imgData.data[i+3] = ubuf[i+3]; //alpha
            }

            ctx.putImageData(imgData,0,0);

        };
        worker.onerror = function(e) {
            console.log("Error in the worker!!",e);
//            document.querySelector('#error').textContent = [
//                'ERROR: Line ', e.lineno, ' in ', e.filename, ': ', e.message].join('');
        };

        function newFile(element){
            // Chrome allows direct transfer of element.files, but that object is not a
            // "transferable" object in mozilla's world.
            // To speed file transfer in a cross-browser way, readAsArrayBuffer here on the main thread
            // then pass the arraybuffer to the worker thread.
            var fr = new FileReader()
            fr.addEventListener("load",function(){

                worker.postMessage(fr.result);
            });
            fr.readAsArrayBuffer(element.files[0]);

        }

    </script>
    <style>
        canvas {
            display: block;
        }
    </style>
</head>
<body>
<input type="file" onchange="newFile(this);">
</body>
</html>
