<html>
<head>
    <title>JIMP + Web Worker Proof of Concept</title>
    <script src="jimp.js" type="text/javascript"></script>
    <script type="text/javascript">

        var worker = new Worker("jimp-worker.js");
        worker.onmessage = function(e) {
            if (typeof e.data.image === "undefined" ||  typeof  e.data.dataUri === "undefined") {
                alert('Worker did not return the expected data');
            }

            // display the processed image by drawing in a canvas:
            paintImageToCanvas(e.data.image);

            // display processed image by data URI:
            paintImageFromDataUri(e.data.dataUri);
        };

        worker.onerror = function(e) {
            alert('WORKER ERROR: Line '+ e.lineno+ ' in '+ e.filename+ ': '+ e.message);
        };

        function paintImageToCanvas(image){
            var canvas = document.createElement("canvas");
            canvas.width = image.width;
            canvas.height = image.height;
            document.body.appendChild(canvas);

            var ctx = canvas.getContext("2d");
            var imgData = ctx.createImageData(image.width,image.height);

            var ubuf = image.data;
            for (var i=0;i < ubuf.length; i+=4) {
                imgData.data[i]   = ubuf[i];   //red
                imgData.data[i+1] = ubuf[i+1]; //green
                imgData.data[i+2] = ubuf[i+2]; //blue
                imgData.data[i+3] = ubuf[i+3]; //alpha
            }

            ctx.putImageData(imgData,0,0);
        }

        function paintImageFromDataUri(dataUri){

        }

        function newFile(element){
            // Chrome allows direct transfer of element.files, but that object is not a
            // "transferable" object in mozilla's world.
            // To speed file transfer in a cross-browser way, readAsArrayBuffer here on the main thread
            // then pass the arraybuffer to the worker thread.
            var fr = new FileReader();
            fr.addEventListener("load",function(){
                worker.postMessage(fr.result);
            });
            fr.readAsArrayBuffer(element.files[0]);
        }

    </script>
    <style>
        canvas {
            display: block;
        }
    </style>
</head>
<body>
<input type="file" onchange="newFile(this);">
</body>
</html>
